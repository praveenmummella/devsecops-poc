version: 0.2

env:
  variables:
    REPORT_BUCKET: devsecopspocreports
    JACOCO_REPORT_PATH: target/site/jacoco/index.html
    JACOCO_REPORT_DIR: target/site/jacoco
    DEPENDENCY_CHECK_REPORT_PATH: target/dependency-check-report.html
    JAVA_VERSION: 17
    MAVEN_OPTS: -Dmaven.compiler.release=17
  parameter-store:
    SONAR_TOKEN: /devsecops/sonar/token
    SONAR_PROJECT_KEY: /devsecops/sonar/projectKey
    SONAR_ORGANIZATION: /devsecops/sonar/organization

phases:
  install:
    runtime-versions:
      java: corretto17
    commands:
      - echo "Installing dependencies..."
      - yum install -y maven docker
      - service docker start
      - echo "Java version: $(java -version 2>&1 | head -1)"
      - echo "Maven version: $(mvn -version | head -1)"

  pre_build:
    commands:
      - echo "Pre-build phase started..."
      - echo "Project Key: $SONAR_PROJECT_KEY"
      - echo "Organization: $SONAR_ORGANIZATION"
      - mkdir -p target/site/jacoco

  build:
    commands:
      - echo "Build phase started..."
      - mvn clean verify jacoco:report org.owasp:dependency-check-maven:check
      - echo "Running SonarCloud analysis..."
      - mvn sonar:sonar -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.organization=$SONAR_ORGANIZATION -Dsonar.login=$SONAR_TOKEN

  post_build:
    commands:
      - echo "Post-build phase started..."
      - echo "Uploading reports..."
      - bash -c '[ -d "$JACOCO_REPORT_DIR" ] && aws s3 cp $JACOCO_REPORT_DIR s3://$REPORT_BUCKET/reports/jacoco/ --recursive --acl public-read || echo "JaCoCo report not found"'
      - bash -c '[ -f "$DEPENDENCY_CHECK_REPORT_PATH" ] && aws s3 cp $DEPENDENCY_CHECK_REPORT_PATH s3://$REPORT_BUCKET/reports/ --acl public-read || echo "Dependency check report not found"'
      - bash -c 'if [ $? -eq 0 ]; then mvn exec:exec@send-success-email; else mvn exec:exec@send-failure-email; fi'

artifacts:
  files:
    - "target/*.jar"
    - "target/*.war"
    - "target/site/jacoco/**/*"
    - "target/dependency-check-report.html"
  name: devsecops-artifacts
  discard-paths: no
